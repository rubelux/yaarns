<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
     <title>Usage</title>
    <link rel="stylesheet" href="_static/haiku.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/print.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '',
        COLLAPSE_INDEX: true,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/theme_extras.js"></script>
   </head> 

     <div class="header"><h1 class="heading"><a href="#">
          <span>Shaker</span></a></h1>
      </div>
      <div class="topnav">
      
        <p>
        <a class="uplink" href="../">Mojito Documentation</a>
        &#160;&#160;::&#160;&#160;
        <a href="index.html" title="Shaker">Shaker</a>
        &#160;&#160;::&#160;&#160;
        
        
        </p>

      </div>
      <div class="content">
   <div class="section" id="usage">
<h1>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h1>
<p>The Shaker recipe is one part convention and one part configuration. The convention lies
in the name you use for your <tt class="docutils literal"><span class="pre">resources</span></tt> (assets, binders, controllers, etc). The
configuration lies in a mojit or application&#8217;s <tt class="docutils literal"><span class="pre">shaker.json</span></tt> file, which defines rollups
and their contents.</p>
<p>We will see every feature/use case that Shaker can handle. Also, to clarify more all
use cases, you can find a lot of examples here.</p>
<div class="section" id="contextualize-context-dimensions">
<span id="usage-context"></span><h2>Contextualize: Context Dimensions<a class="headerlink" href="#contextualize-context-dimensions" title="Permalink to this headline">¶</a></h2>
<p>First we need to understand how we can contextualize assets in Mojito, and then how we can
leverage this process with Shaker.</p>
<div class="section" id="how-it-works-out-of-the-box-in-mojito">
<span id="context-how"></span><h3>How It Works Out-of-the-Box in Mojito<a class="headerlink" href="#how-it-works-out-of-the-box-in-mojito" title="Permalink to this headline">¶</a></h3>
<p>In Mojito, we have a context for every request. This context has properties like language,
region, device, bucket, and any other synthetic dimension that we could potentially add.</p>
<p>Giving a particular dimension, we may want to do different things. For example, if I’m on
an iPhone, I may want mobile-specific CSS, or I may want to execute a different controller.
In order to do that, Mojito has <em>selectors</em>. For every particular set of attributes on a
context you can define a selector. This is what it looks like in your <tt class="docutils literal"><span class="pre">application.json</span></tt>:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="p">{</span>
  <span class="s2">&quot;settings&quot;</span><span class="o">:</span> <span class="p">[</span><span class="s2">&quot;device:iphone&quot;</span><span class="p">],</span>
  <span class="s2">&quot;selector&quot;</span><span class="o">:</span> <span class="s2">&quot;iphone&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Creating a resource sensitive to that selector is as simple as adding the selector to the
file name:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">controller.iphone.common.js</span></tt> - <tt class="docutils literal"><span class="pre">iphone</span></tt> is the selector</li>
<li><tt class="docutils literal"><span class="pre">myview.bucket4.client.js</span></tt>    - <tt class="docutils literal"><span class="pre">bucket4</span></tt> is the selector</li>
<li><tt class="docutils literal"><span class="pre">binder.tablet.js</span></tt>            - <tt class="docutils literal"><span class="pre">tablet</span></tt> is the selector</li>
</ul>
<p>Properly configured, Mojito will pick the right version of your resources at runtime.</p>
<p>Note that in Mojito, selectors only work for JavaScript files; they will not have
any effect on CSS files. Shaker will take care of that, and we will show how in the
next section.
&#8216;
.. _context-do:</p>
</div>
<div class="section" id="what-shaker-does-with-the-context">
<h3>What Shaker Does with the Context<a class="headerlink" href="#what-shaker-does-with-the-context" title="Permalink to this headline">¶</a></h3>
<p>Using Mojito&#8217;s selector feature, we can bundle the right
resources for a context on the client without negatively affecting performance.</p>
<p>At build time, Shaker will analyze the application using the Mojito Store API and will
generate all the possible combinations that the application is aware of. This applies
not only for JavaScript, but for CSS as well. Moreover, we need to serve different CSS for
different actions.</p>
<p><strong>Example of contextualizing for a Mojito with two actions and two possible devices:</strong></p>
<div class="figure align-center" style="width: 665px">
<img alt="Mojito with two actions and two possible devices." src="_images/contextualize.png" />
</div>
<p>In Mojito, all the resources are YUI Modules, which means that in addition to knowing which
resources we will choose, we can also know in advance the dependencies that those modules
require. With those two features, we can ensure that the bundle contains exactly the
resources we need.</p>
</div>
<div class="section" id="javascript-calculation">
<span id="context-js-calculation"></span><h3>JavaScript Calculation<a class="headerlink" href="#javascript-calculation" title="Permalink to this headline">¶</a></h3>
<p>Because we are using the YUI module pattern for our resources, at build time, we can
analyze the dependencies of a mojit for every given context and action. For example, this
is the controller module of a regular mojit:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">YUI</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;Main&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Y</span><span class="p">,</span> <span class="nx">NAME</span><span class="p">)</span> <span class="p">{</span>
<span class="p">...</span>
<span class="p">},</span> <span class="s1">&#39;0.0.1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">requires</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;mojito&#39;</span><span class="p">,</span><span class="s1">&#39;mojito-assets-addon&#39;</span><span class="p">,</span> <span class="s1">&#39;mojito-models-addon&#39;</span><span class="p">,</span> <span class="s1">&#39;MainModelFoo&#39;</span><span class="p">]});</span>
</pre></div>
</div>
<p>We know that when this mojit gets dispatched it will need a model resource called
<tt class="docutils literal"><span class="pre">MainModelFoo</span></tt>, so we can compute that ahead of time and serve everything rolled up.</p>
<p>In <tt class="docutils literal"><span class="pre">mojito&#64;0.5.x</span></tt>, a new feature was introduced where all the needed dependencies will be
fetched and combo loaded automatically for us. We can configure Shaker to serve
this combo load from a CDN (if you have a CDN which support combo loading), and even prefetch
some of the dependencies combining mojit bundles.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you are running an earlier version than Mojito v0.5.x, Shaker will
automatically load the JavaScript dependencies for you.</p>
</div>
</div>
<div class="section" id="css-selector-naming-rules">
<span id="context-css-selector"></span><h3>CSS Selector Naming Rules<a class="headerlink" href="#css-selector-naming-rules" title="Permalink to this headline">¶</a></h3>
<p>After reading and understanding the previous sections, let&#8217;s summarize the protocol that
Shaker follows to deliver CSS:</p>
<ul class="simple">
<li>Every CSS file with no selector (e.g., <tt class="docutils literal"><span class="pre">foo.css</span></tt>) will be considered <tt class="docutils literal"><span class="pre">common</span></tt>,
therefore, will be included in each bundle within the mojit.</li>
<li>If a file has selector (e.g., <tt class="docutils literal"><span class="pre">foo.iphone.css</span></tt>), it will be included when the context
matches.</li>
<li>If two files have the same name but different selectors
(e.g., <tt class="docutils literal"><span class="pre">foo.css</span></tt>, <tt class="docutils literal"><span class="pre">foo.iphone.css</span></tt>) the correct one will be chosen.
We call this versioning.</li>
<li>If a file name matches the view name, the CSS will be included only when the
context and the executed action match (serve the assets for the right actions).</li>
</ul>
</div>
<div class="section" id="generating-mojit-rollups-shaker-metadata">
<span id="context-mojit-rollups"></span><h3>Generating Mojit Rollups: Shaker Metadata<a class="headerlink" href="#generating-mojit-rollups-shaker-metadata" title="Permalink to this headline">¶</a></h3>
<p>Assuming that the assets of your mojits have been named correctly (see sections above),
Shaker will be ready to analyze your application and bundle them.</p>
<p>When running Shaker, it will go over all the JavaScript and CSS resources for each mojit,
checking dependencies (in the case of YUI modules), and based on the context, the
configuration you provided (we will see more about those in the next section), it will
construct the list or resources that each bundle will contain.</p>
<p>This information will be stored in a file called <tt class="docutils literal"><span class="pre">shaker-metadata</span></tt>, which will be used
at runtime to know which bundles to serve.</p>
<p><strong>Metadata generated by Shaker for a mojit with two actions:</strong></p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;mojits&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;Main&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;index&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;js&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;/static/autoloadGlobal.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/MainBinderIndex.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/MainModelFoo.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/Main.js&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;css&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;/static/Main/assets/mainBase.css&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/Main/assets/index.css&quot;</span>
            <span class="p">]</span>
        <span class="p">},</span>
        <span class="s2">&quot;other&quot;</span><span class="o">:</span> <span class="p">{</span>
            <span class="s2">&quot;js&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;/static/MainBinderOther.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/MainModelFoo.js&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/Main.js&quot;</span>
            <span class="p">],</span>
            <span class="s2">&quot;css&quot;</span><span class="o">:</span> <span class="p">[</span>
                <span class="s2">&quot;/static/Main/assets/mainBase.css&quot;</span><span class="p">,</span>
                <span class="s2">&quot;/static/Main/assets/other.css&quot;</span>
            <span class="p">]</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We will see in the next sections how to customize the content of the rollups (minification,
deployment to CDN, bootstrapping, etc.) through configuration.</p>
</div>
</div>
<div class="section" id="environment-and-context-configuration">
<span id="env-context"></span><h2>Environment and Context Configuration<a class="headerlink" href="#environment-and-context-configuration" title="Permalink to this headline">¶</a></h2>
<p>Shaker allows you to roll up your assets and deploy them in a variety of ways based on the
environment context. For example, in production, you would like to minify your rollups and
upload them to a CDN, whereas, on your development machine, you may only want to lint
them and serve them separately.</p>
<dl class="docutils">
<dt>All that is necessary is to provide a <tt class="docutils literal"><span class="pre">shaker</span></tt> configuration object for each</dt>
<dd>environment in your <tt class="docutils literal"><span class="pre">application.json</span></tt> file. The <tt class="docutils literal"><span class="pre">shaker</span></tt> object specifies what task</dd>
</dl>
<p>to run and any additional settings the task depends on.</p>
<p><strong>Example:</strong> Sample <tt class="docutils literal"><span class="pre">application.json</span></tt> shaker setup using several environments:</p>
<div class="highlight-javascript"><pre>[{
    "settings": ["master"]
    "shaker: {
        //default configuration
    }
}, {
    "settings": ["environment:test"],
    "shaker": {
        "task": "local"
        "lint": false,
        "minify": true,
        "rollupConfig": {
            bundleViews: false,
            bundleController: false
        }
    }
}, {
    "settings": ["environment:stage"],
    "shaker": {
        "task": "s3",
        "config": {
            "client": {
                "key": "&lt;key&gt;",
                "secret": "&lt;secret&gt;",
                "bucket": "&lt;bucket&gt;"
            }
        }
    }
}]</pre>
</div>
<p>The previous configuration will give us three different types of execution environments.
To build a particular environment, run the shaker command like so: <tt class="docutils literal"><span class="pre">mojito</span> <span class="pre">shake</span> <span class="pre">--context</span> <span class="pre">environment:&lt;env&gt;</span></tt>
After running Shaker, start your Mojito application normally.</p>
<p>The following sections offer commands for deploying assets in different environments.</p>
<div class="section" id="deploying-raw-no-rollups-developer-mode">
<span id="context-deploy-raw"></span><h3>Deploying Raw (No Rollups, Developer Mode)<a class="headerlink" href="#deploying-raw-no-rollups-developer-mode" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">mojito</span> <span class="pre">shake</span></tt></p>
</div>
<div class="section" id="deploying-locally-rollups-test-mode">
<span id="context-deploy-locally"></span><h3>Deploying Locally (Rollups, Test Mode)<a class="headerlink" href="#deploying-locally-rollups-test-mode" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">mojito</span> <span class="pre">shake</span> <span class="pre">--context</span> <span class="pre">environment:test</span></tt></p>
</div>
<div class="section" id="deploying-to-s3-amazon-cdn-staging">
<span id="context-deploy-cdn"></span><h3>Deploying to S3 (Amazon CDN, Staging)<a class="headerlink" href="#deploying-to-s3-amazon-cdn-staging" title="Permalink to this headline">¶</a></h3>
<p><tt class="docutils literal"><span class="pre">mojito</span> <span class="pre">shake</span> <span class="pre">--context</span> <span class="pre">environment:stage</span></tt></p>
</div>
<div class="section" id="shaker-settings">
<span id="context-shaker-settings"></span><h3>Shaker Settings<a class="headerlink" href="#shaker-settings" title="Permalink to this headline">¶</a></h3>
<p>As you saw in the code example above, for every environment we can set a different
configuration for Shaker. These are some of the options we saw in the
<tt class="docutils literal"><span class="pre">application.json</span></tt> example:</p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">task</span></tt> - {string} Name of task to execute (local, s3, raw, etc.). Defaults to <tt class="docutils literal"><span class="pre">raw</span></tt>
when running in development mode.</li>
<li><tt class="docutils literal"><span class="pre">lint</span></tt> - {boolean} Run lint on application files. The default is <tt class="docutils literal"><span class="pre">true</span></tt>.</li>
<li><tt class="docutils literal"><span class="pre">minify</span></tt> - {boolean} Minify JS and CSS. Defaults to true.</li>
<li><tt class="docutils literal"><span class="pre">rollupConfig</span></tt> - {Object} It tells Shaker which parts to deploy to the client
(binders, views, controllers, or all of them).</li>
</ul>
<p>For all the options available in Shaker, see <a class="reference external" href="./shaker_api_summary.html">Shaker Configuration API</a>.</p>
</div>
</div>
<div class="section" id="bundling-mojits-together">
<span id="usage-bundling"></span><h2>Bundling Mojits Together<a class="headerlink" href="#bundling-mojits-together" title="Permalink to this headline">¶</a></h2>
<p>In the previous sections, we covered how Shaker works to create rollups for every mojit.
Thus, the client we will have to fetch at least one CSS rollup/request per
mojit and the request necessary for the JavaScript.</p>
<p>When there are too many mojits to execute, we should combine all the rollups in
one to serve all the CSS at once and remove the overhead of multiple connections. To
address this problem, Shaker defines what we call <em>high-coverage</em> mojits and
<em>low-coverage</em> mojits, which we will discuss next.</p>
<div class="section" id="high-coverage-mojits">
<span id="bundling-hc-mojits"></span><h3>High-Coverage Mojits<a class="headerlink" href="#high-coverage-mojits" title="Permalink to this headline">¶</a></h3>
<p>Definition: Ability to define ahead of time which mojits to bundle together so we just
require one request  for the first flush of the page.</p>
<p>Earlier, we saw that Shaker will build rollups for every mojit and for
every possible set of configuration our application supports, which will reduce
considerably the number of requests. But if we have a lot of mojits to dispatch and flush
to the client, we will still end up doing a lot of CSS and JavaScript requests.</p>
<p>In this situation, Shaker allow us to define what we call high-coverage mojits.
For every route defined in our application, we can tell Shaker which mojits are most likely
to be loaded and then bundle all them together. The following is the syntax for bundling
high-coverage mojits:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">shaker</span><span class="o">:</span><span class="p">{</span>
    <span class="s2">&quot;routeBundle&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">//we define for each route which mojits we want to bundle together</span>
        <span class="s2">&quot;foo&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;Main.index&quot;</span>
        <span class="p">],</span>
        <span class="s2">&quot;bar&quot;</span><span class="o">:</span> <span class="p">[</span>
            <span class="s2">&quot;mojitB.index&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mojibC.other&quot;</span>
        <span class="p">]</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>At build time, Shaker will analyze <tt class="docutils literal"><span class="pre">routeBundle</span></tt> and generate the
specific rollups for you. Note that all these rollups will be context specific, so
it ships only what we need for a given context.</p>
</div>
<div class="section" id="low-coverage-mojits">
<span id="bundling-lc-mojits"></span><h3>Low-Coverage Mojits<a class="headerlink" href="#low-coverage-mojits" title="Permalink to this headline">¶</a></h3>
<p>Definition: Load (lazily/dynamically) a mojit with its own JavaScript and CSS bundle.</p>
<p>Low-coverage mojits are all the mojits which are not defined in <tt class="docutils literal"><span class="pre">routeBundle</span></tt>.
Shaker has to provide as well as bundle independent mojits that may
be loaded after the page has already been rendered or when the user clicks a link
that triggers the dispatch of a new mojit.</p>
<p>If there are no high-coverage bundles, the default behavior is to load the mojits as
<strong>low coverage</strong>.</p>
<p>Because the Mojito v0.5.x handles the JavaScript with a local combo load, the only
problem when not specifying high-coverage mojits is the number of CSS requests
that need to be made.</p>
</div>
<div class="section" id="bundling-parts-of-a-mojit-rollupconfig">
<span id="bundling-parts"></span><h3>Bundling Parts of a Mojit: rollupConfig<a class="headerlink" href="#bundling-parts-of-a-mojit-rollupconfig" title="Permalink to this headline">¶</a></h3>
<p>Going back to the bundles, we saw which resources to take into account, how to manage the
dependencies, and how to select the right resources based on the context. We still, however,
have to define which parts are going to be included.</p>
<p>So, depending on the application needs, we may want to ship only the minimum amount of
JavaScript to the page (the binders and the bare-bone Mojito client code), or we may want
to ship absolutely everything (controller, binders, dependencies, views, langs, etc.).</p>
<p>Shaker has to provide a way to select which components you want to rollup for every mojit.
We could define this configuration at the application level, if we want to share all the
configuration across mojits, or we can define small configuration files in each mojit
to override which parts to bundle.</p>
<p>The configuration API will look something like:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;shaker&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;rollupConfig&quot;</span><span class="o">:</span> <span class="p">{</span>
          <span class="s2">&quot;bundleViews&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="s2">&quot;bundleController&quot;</span><span class="o">:</span> <span class="kc">false</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>With that, we can customize the parts we will include in the bundles. Note that Shaker
should also provide a way to bundle all components together, so offline applications have
almost no configuration.</p>
</div>
</div>
<div class="section" id="inlining-code">
<span id="usage-inlining"></span><h2>Inlining Code<a class="headerlink" href="#inlining-code" title="Permalink to this headline">¶</a></h2>
<p>Sometimes we need to execute JavaScript or load CSS styles as quickly as possible to give
our users a good user experience. In Mojito v0.5.x, you can inline code using the core APIs,
but you will have to hard-code the code into your controllers, and this is not really ideal.</p>
<p>In Shaker, we came up with an automated way to do this. You just have to create a file with
a special the selector <tt class="docutils literal"><span class="pre">shaker-inline</span></tt> in your mojit, and this file will be inline and
served when the mojit is dispatched. Given that a mojit can have different behavior
depending on the action, inlining is also sensible to the action, so if the name of your
inline file matches an existing action in your mojit, it will be only inlined when the
action matches at runtime.</p>
<p>By default, the code is inlined at the bottom of the page, before the Mojito client code
is executed. If you want to inline the code right after
the HTML generated by a particular mojit, you just have to include in your controller a
dependency called <tt class="docutils literal"><span class="pre">shaker-inline</span></tt>. See examples about inlining in the
<a class="reference external" href="./shaker_examples.html">Shaker App Example</a>.</p>
<p><strong>Summary example:</strong></p>
<ul class="simple">
<li><tt class="docutils literal"><span class="pre">myInline.shaker-inline.css</span></tt> - this will be inlined for any action within the mojit.</li>
<li><tt class="docutils literal"><span class="pre">mojitAction1.shaker-inline.js</span></tt> - Assuming that there is an action with his
corresponding view called <tt class="docutils literal"><span class="pre">mojitAction1</span></tt>, the code will be inlined at runtime when
<tt class="docutils literal"><span class="pre">mojitAction1</span></tt> is executed.</li>
<li><tt class="docutils literal"><span class="pre">myInline.iphone.shaker-inline.js</span></tt> - this will be inlined when the context (in this
case <tt class="docutils literal"><span class="pre">iphone</span></tt>) matches at runtime.</li>
</ul>
<div class="highlight-javascript"><div class="highlight"><pre><span class="nx">YUI</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="s1">&#39;MainController&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Y</span><span class="p">,</span> <span class="nx">NAME</span><span class="p">)</span> <span class="p">{</span>
<span class="c1">// My controller code</span>
<span class="p">},</span> <span class="s1">&#39;0.0.1&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">requires</span><span class="o">:</span> <span class="p">[</span><span class="s1">&#39;mojito&#39;</span><span class="p">,</span> <span class="s1">&#39;shaker-inline-addon&#39;</span><span class="p">]});</span>
</pre></div>
</div>
</div>
<div class="section" id="dynamic-parallel-bootstrap">
<span id="usage-bootstrap"></span><h2>Dynamic &amp; Parallel Bootstrap<a class="headerlink" href="#dynamic-parallel-bootstrap" title="Permalink to this headline">¶</a></h2>
<p>By default, the <tt class="docutils literal"><span class="pre">&lt;script</span> <span class="pre">src=...&gt;&lt;/script&gt;</span></tt> tag is evil! The browser must halt parsing
the HTML until the script is downloaded and executed (since the script might call
<tt class="docutils literal"><span class="pre">document.write()</span></tt> or define global variables that the scripts depend on). Images and
style sheets that come after the <tt class="docutils literal"><span class="pre">script</span></tt> tag don&#8217;t start downloading
until after the script has finished downloading and executing. External scripts typically
make the page load much more slowly, which is why NoScript has become so popular.</p>
<p>W3C introduced the <tt class="docutils literal"><span class="pre">defer</span></tt> attribute to solve the problem. If you use
<tt class="docutils literal"><span class="pre">&lt;script</span> <span class="pre">defer</span> <span class="pre">src=...&gt;&lt;/script&gt;</span></tt>, do not call <tt class="docutils literal"><span class="pre">document.write()</span></tt>. A
deferred external script will start downloading immediately but won&#8217;t execute until after
the page is rendered. The problem with <tt class="docutils literal"><span class="pre">defer</span></tt> is that the W3C HTML5 draft has removed
<tt class="docutils literal"><span class="pre">defer</span></tt> from inlined scripts due to execution order guarantee, and also <tt class="docutils literal"><span class="pre">defer</span></tt> is not
supported in some browsers.</p>
<p>The alternative we suggest is to dynamically load scripts. Here is a snippet illustrating
how to dynamically load scripts:</p>
<div class="highlight-html"><div class="highlight"><pre><span class="nt">&lt;script&gt;</span>
  <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">script</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">);</span>
    <span class="nx">script</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s1">&#39;...&#39;</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">s</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementsByTagName</span><span class="p">(</span><span class="s1">&#39;script&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
    <span class="nx">s</span><span class="p">.</span><span class="nx">parentNode</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">script</span><span class="p">,</span> <span class="nx">s</span><span class="p">);</span>
  <span class="p">})();</span>
<span class="nt">&lt;/script&gt;</span>
</pre></div>
</div>
<p>Shaker implements, as a configuration option, a mechanism that dynamically loads the
JavaScript bundles. Moreover, because we don’t control the order anymore, we implemented
a special bootstrap to make sure YUI gets bootstrapped correctly. If you want to use the
optimized bootstrap into your Mojito application, just add the option
<tt class="docutils literal"><span class="pre">optimizeBootstrap:</span> <span class="pre">true</span></tt> in your Shaker configuration.</p>
</div>
<div class="section" id="k-weight-splitting">
<span id="usage-splitting"></span><h2>K-Weight Splitting<a class="headerlink" href="#k-weight-splitting" title="Permalink to this headline">¶</a></h2>
<p>We have discussed <strong>high-coverage</strong> bundles and also <strong>Rollup configuration</strong>
in the previous sections. Both can result in gigantic rollups that will
require a significant amount of time to load.</p>
<p>Because we have dynamic script loading and a mechanism that guarantees the order, one other
feature that Shaker provide is the ability to split those bundles into chunks that
can be loaded in parallel. Shaker provides an API to define the threshold for the size of the
chunks. Then, at build time, Shaker will split the rollup so we can optimize the loading
time.</p>
<div class="highlight-javascript"><div class="highlight"><pre><span class="s2">&quot;shaker&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="c1">// This are the default values:</span>
    <span class="s2">&quot;ksplit&quot;</span><span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;weight&quot;</span><span class="o">:</span> <span class="mi">100</span> <span class="c1">// the kb limit for splitting</span>
        <span class="s2">&quot;threshold&quot;</span><span class="o">:</span> <span class="mi">20</span> <span class="c1">// the percentage of threshold to split the rollup</span>
        <span class="s2">&quot;&quot;</span><span class="o">:</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The properties of <tt class="docutils literal"><span class="pre">ksplit</span></tt> specifies that Shaker should chunk files bigger than 100kb
with a margin of 20%. In other words, files will be split into pieces with a size between
80kb and 120kb. You can set <tt class="docutils literal"><span class="pre">ksplit:true</span></tt> to work with the default values.</p>
</div>
</div>

   </div>
